{% extends "layout.html" %}
{% block title %}
Imports
{% endblock %}
{% block content %}
<script>
    
    $(document).ready( function () {
        $('#imports').DataTable();
    });
</script>

<div class="container-fluid mt-3">
    {% if not context.isPost%}
    <h3>Import Data</h3>
    <form action="{{ url_for('show_imports') }}" method="POST">
        <div class="row justify-content-md-left mb-3">
            <div class="col-2">
                <select name='source' class="form-select form-select-md" aria-label=".form-select-lg example">
                    <option selected>Source</option>
                    <option value="jita">Jita IV - Moon 4 - Caldari Navy Assembly Plant</option>
                    {% for key, val in context.structures.items() %}
                    <option value="{{key}}">{{val}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-2">
                <select name='destination' class="form-select form-select-md" aria-label=".form-select-lg example">
                    <option selected>Desination</option>
                    <option value="jita">Jita IV - Moon 4 - Caldari Navy Assembly Plant</option>
                    {% for key, val in context.structures.items() %}
                    <option value="{{key}}">{{val}}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="row justify-content-md-left">
            <div class="col-2 mb-3">
                <input type="text" class="form-control" name="analysisPeriod" placeholder="Analysis Period (days)" aria-label="Analysis Period (days)">
            </div>
        </div>
        <div class="row justify-content-md-left">
            <div class="col-2 mb-3">
                <input type="text" class="form-control" name="aggregatePeriod" placeholder="Aggregate Over (days)" aria-label="Aggregate Over (days)">
            </div>
        </div>

        <div class="container">
            <div class="row row-cols-3">
            </div>
        </div>

        <div class="col-2 mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="updatePrices" id="updatePrices">
              <label class="form-check-label" for="updatePrices">
                Update Prices
              </label>
            </div>
        </div>

        <h5>Select items to be queried</h5>
        <div class="col-2 mb-3">
            <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                Button with data-bs-target
            </button>
        </div>
        <div class="collapse" id="collapseExample">
            <div class="card card-body">
                <div id="jstreeDiv">
                    <ul class="collapsibleList">
                        {% for key, value in context.marketGroups.items() %}
                            {% if key != 'id' %}
                            <li>
                                <input style="margin-right:5px;" type="checkbox" value="{{value['id']}}" name="groups">{{key}}
                                <ul class="collapsibleList">
                                    {% for key2, value2 in value.items() %}
                                        {% if key2 != 'id' and key2 != '-1' %}
                                            {% if 'id' in value2.keys() %}
                                            <li>
                                                <input style="margin-right:5px;" type="checkbox" value="{{value2['id']}}" name="groups">{{key2}}
                                                <ul>
                                                    {% for key3, value3 in value2.items() %}
                                                        {% if key3 != 'id' and key3 != '-1' %}
                                                            {% if 'id' in value3.keys() %}
                                                            <li>
                                                                <input style="margin-right:5px;" type="checkbox" value="{{value3['id']}}" name="groups">{{key3}}
                                                            </li>
                                                            {% else %}
                                                            <li>
                                                                <input style="margin-right:5px;" type="checkbox" value="{{value3['-1']}}" name="groups">{{key3}}
                                                            </li>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </ul>
                                            </li>
                                            {% else %}
                                            <li>
                                                <input style="margin-right:5px;" type="checkbox" value="{{value2['-1']}}" name="groups">{{key2}}
                                                <ul>
                                                    {% for key3, value3 in value2.items() %}
                                                        {% if key3 != '-1' %}
                                                        <li>
                                                            <input style="margin-right:5px;" type="checkbox" value="{{key3}}" name="items">{{value3}}
                                                        </li>
                                                        {% endif %}
                                                    {% endfor %}
                                                </ul>
                                            </li>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Submit</button>
    </form>
    {% else %}
    <table id="imports" class="table table-bordered table-striped">
        <thead class="thead-light">
            <tr>
                <th>Item</th>
                <th>Src. Price</th>
                <th>Dst. Price</th>
                <th>Dst. Order Count</th>
                <th>Dst. Remaining Volume</th>
                <th>Agg. Average Volume</th>
                <th>Dst. Percent Agg Vol Remaining</th>
                <th>Price Difference</th>
                <th>M3</th>
                <th>Shipping Price</th>
                <th>Profit after Market Fees</th>
            </tr>
        </thead>
        <tbody>
        {% for key, value in context.imports.items() %}
            {% if value.sourcePrice - value.destoPrice > 0 %}
            <tr class="table-warning">
            {% else %}
            <tr>
            {% endif %}
                <td>{{value.itemName}}</td>
                <td>{{value.sourcePrice | numberFormat}}</td>
                <td>{{value.destoPrice | numberFormat}}</td>
                <td>{{value.numOrders}}</td>
                <td>{{value.remainingVolume}}</td>
                <td>{{value.aggPeriodAvg}}</td>
                <td>{{((value.remainingVolume / value.aggPeriodAvg) * 100)|round(1)|float}}</td>
                <td>{{(value.destoPrice - value.sourcePrice) | numberFormat}}</td>
                <td>{{value.m3 | numberFormat}}</td>
                <td>{{((value.m3 * context.pricePerM3) + (value.sourcePrice * context.collateralPercentage)) | numberFormat}}</td>
                <td>{{(((value.destoPrice - value.sourcePrice) - ((value.m3 * context.pricePerM3) + (value.sourcePrice * context.collateralPercentage))) - value.destoPrice * ((context.brokerFee - context.transactionTax) / 100)) | numberFormat}}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
<script>
    $(function () { $('#jstreeDiv').jstree(); });

    $('#jstreeDiv').on("changed.jstree", function (e, data) {
        console.log(data.selected);
    });

    $('button').on('click', function () {
        $('#jstree').jstree(true).select_node('child_node_1');
        $('#jstree').jstree('select_node', 'child_node_1');
        $.jstree.reference('#jstree').select_node('child_node_1');
    });

    //TODO: Implement JSTree checkboxes
</script>
{% endblock %}